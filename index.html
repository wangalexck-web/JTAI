<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚è¦‹å±± CAMP - é è¨‚ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .custom-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="bg-slate-50">
    <div class="max-w-md mx-auto p-4 min-h-screen pb-32">
        <header class="text-center py-8">
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">æ¨‚è¦‹å±± CAMP</h1>
            <p class="text-[10px] text-slate-400 tracking-[0.2em] uppercase mt-1">Peaceful Mountain Retreat</p>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Step 1. é è¨‚æ—¥æœŸ</label>
            <input type="text" id="dateRange" class="w-full p-4 border-none rounded-2xl text-lg text-center bg-slate-100 font-bold text-slate-700 focus:ring-2 focus:ring-slate-200" placeholder="é»æ“Šé¸æ“‡æ—¥æœŸ">
            
            <div id="sunday-alert" class="hidden mt-4 p-4 bg-orange-50 border border-orange-100 rounded-2xl">
                <p class="text-sm text-orange-900 leading-relaxed">
                    âœ¨ ç‚ºäº†çµ¦æ‚¨æœ€ä¹¾æ·¨çš„ç’°å¢ƒï¼Œ<strong>é€±æ—¥é€²å ´æ™‚é–“ç‚º 14:00 å¾Œ</strong>ã€‚ç‡Ÿä¸»æ­£åœ¨ç‚ºæ‚¨çš„åˆ°ä¾†é€²è¡Œæœ€å¾Œæ•´å‚™ï¼Œæ„Ÿè¬æ‚¨çš„é«”è«’ã€‚
                </p>
            </div>
        </div>

        <div id="weekend-lock" class="hidden bg-indigo-50 p-8 rounded-3xl border border-indigo-100 text-center mb-4">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                <span class="text-3xl">ğŸŒ¿</span>
            </div>
            <h3 class="text-indigo-900 font-bold text-lg mb-2">é€±äº”ã€é€±å…­æ™‚æ®µ</h3>
            <p class="text-sm text-indigo-600 mb-6 leading-relaxed">é€±æœ«ç†±é–€æ™‚æ®µç›®å‰çµ±ä¸€ç”±ã€æ„›éœ²ç‡Ÿã€‘å¹³å°ç®¡ç†ï¼Œè«‹å‰å¾€æ¨‚è¦‹å±±å°ˆå±¬é é¢é è¨‚ã€‚</p>
            <button onclick="window.open('https://m.icamping.app/store/ljs761', '_blank')" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                å‰å¾€æ„›éœ²ç‡Ÿ (æ¨‚è¦‹å±±å°ˆå±¬)
            </button>
        </div>

        <div id="zone-selection" class="hidden">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">Step 2. é¸æ“‡ç‡Ÿä½</label>
            <div id="zone-list" class="space-y-3 mb-8"></div>

            <div class="fixed bottom-6 left-4 right-4 max-w-md mx-auto custom-gradient text-white p-6 rounded-3xl shadow-2xl">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] opacity-50 uppercase font-bold" id="summary-count">æœªé¸æ“‡å€åŸŸ</p>
                        <p id="total-price" class="text-2xl font-bold text-emerald-400">NT$ 0</p>
                    </div>
                    <button onclick="handleBooking()" id="submit-btn" class="bg-emerald-500 px-8 py-4 rounded-2xl font-bold text-white shadow-lg disabled:opacity-20 disabled:grayscale transition-all active:scale-95">
                        ç¢ºèªè¨‚ä½
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://evdnzkvrmjnuzomogzar.supabase.co', 'sb_publishable_Tlpp57LlXUwYBRX84lI4WQ_MCv74hVQ');
        let selectedDates = [];
        let cart = {}; 

        flatpickr("#dateRange", {
            mode: "range",
            minDate: "today",
            dateFormat: "Y-m-d",
            onClose: function(dates) {
                if (dates.length === 2) {
                    selectedDates = dates;
                    checkAvailability();
                }
            }
        });

        async function checkAvailability() {
            // UI é‡ç½®
            document.getElementById('sunday-alert').classList.add('hidden');
            const lockBox = document.getElementById('weekend-lock');
            const zoneBox = document.getElementById('zone-selection');
            
            // é€±æœ«åµæ¸¬ (5:é€±äº”, 6:é€±å…­)
            let hasWeekend = false;
            let scanDate = new Date(selectedDates[0]);
            let checkoutDate = new Date(selectedDates[1]);

            while (scanDate < checkoutDate) {
                if (scanDate.getDay() === 5 || scanDate.getDay() === 6) {
                    hasWeekend = true;
                    break;
                }
                scanDate.setDate(scanDate.getDate() + 1);
            }

            if (hasWeekend) {
                lockBox.classList.remove('hidden');
                zoneBox.classList.add('hidden');
                return;
            } else {
                lockBox.classList.add('hidden');
                zoneBox.classList.remove('hidden');
            }

            // é€±æ—¥æé†’
            if (selectedDates[0].getDay() === 0) {
                document.getElementById('sunday-alert').classList.remove('hidden');
            }

            const start = selectedDates[0].toLocaleDateString('en-CA');
            const end = selectedDates[1].toLocaleDateString('en-CA');

            // æŠ“å–åº«å­˜èˆ‡å¹³æ—¥æ¸›å¸³æ¯”ä¾‹
            const { data: inventoryData } = await _supabase.from('inventory').select('*, zones(*)').gte('date', start).lt('date', end);
            const { data: rules } = await _supabase.from('site_rules').select('*');
            const weekdayRule = rules.find(r => r.id === 'weekday');

            renderZones(inventoryData, weekdayRule ? weekdayRule.max_spots_ratio : 0.34);
        }

        function renderZones(data, ratio) {
            const list = document.getElementById('zone-list');
            list.innerHTML = "";
            cart = {};
            const zoneMap = {};

            data.forEach(item => {
                if (!zoneMap[item.zone_id]) {
                    zoneMap[item.zone_id] = { 
                        name: item.zones.name, 
                        total_spots: item.zones.total_spots,
                        min_avail: 99, total_price: 0, days: 0
                    };
                }
                const dynamicMax = Math.max(1, Math.floor(item.zones.total_spots * ratio));
                const currentAvail = Math.min(dynamicMax, item.remaining_spots);
                zoneMap[item.zone_id].min_avail = Math.min(zoneMap[item.zone_id].min_avail, currentAvail);
                zoneMap[item.zone_id].total_price += item.current_price;
                zoneMap[item.zone_id].days++;
            });

            Object.keys(zoneMap).forEach(id => {
                const z = zoneMap[id];
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm";
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-slate-800">${z.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">å¹³æ—¥é–‹æ”¾ä¸Šé™: ${z.min_avail} å¸³</div>
                    </div>
                    <select onchange="updateCart('${id}', this.value, ${z.total_price/z.days}, '${z.name}')" class="p-3 bg-slate-50 border-none rounded-xl text-sm font-bold focus:ring-2 focus:ring-emerald-500">
                        <option value="0">ä¸é è¨‚</option>
                        ${Array.from({length: z.min_avail}, (_, i) => `<option value="${i+1}">${i+1} å¸³</option>`).join('')}
                    </select>
                `;
                list.appendChild(card);
            });
            updateUI();
        }

        function updateCart(id, qty, price, name) {
            if (parseInt(qty) > 0) {
                cart[id] = { quantity: parseInt(qty), pricePerNight: price, name: name };
            } else {
                delete cart[id];
            }
            updateUI();
        }

        function updateUI() {
            const nights = Math.ceil((selectedDates[1] - selectedDates[0]) / 86400000);
            let total = 0; let count = 0;
            Object.values(cart).forEach(item => {
                total += item.quantity * item.pricePerNight * nights;
                count++;
            });
            document.getElementById('total-price').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summary-count').innerText = count > 0 ? `å·²é¸ ${count} å€` : "å°šæœªé¸æ“‡";
            document.getElementById('submit-btn').disabled = count === 0;
        }

        async function handleBooking() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = `è™•ç†ä¸­...`;

            const zoneIds = Object.keys(cart);
            const guestCounts = zoneIds.map(id => cart[id].quantity);
            const totalPrice = parseInt(document.getElementById('total-price').innerText.replace(/[NT$, ]/g, ''));

            const { data, error } = await _supabase.rpc('create_camp_booking_v2', {
                p_user_id: 'Guest_User',
                p_zone_ids: zoneIds,
                p_check_in: selectedDates[0].toLocaleDateString('en-CA'),
                p_check_out: selectedDates[1].toLocaleDateString('en-CA'),
                p_total_price: totalPrice,
                p_guest_counts: guestCounts
            });

            if (error) {
                alert("é è¨‚å¤±æ•—ï¼š" + error.message);
                btn.disabled = false;
                btn.innerHTML = "ç¢ºèªè¨‚ä½";
            } else {
                alert("é è¨‚æˆåŠŸï¼æ¨‚è¦‹å±±æœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚");
                location.reload();
            }
        }
    </script>
</body>
</html>
