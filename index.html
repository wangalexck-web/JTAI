<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚è¦‹å±± CAMP - é è¨‚ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-slate-50 font-sans">
    <div class="max-w-md mx-auto p-4 min-h-screen pb-32">
        <header class="text-center py-8">
            <h1 class="text-3xl font-black text-slate-800 tracking-tighter italic">æ¨‚è¦‹å±± CAMP</h1>
            <div id="project-tag" class="hidden mt-2 inline-block px-3 py-1 bg-rose-100 text-rose-600 text-[10px] font-bold rounded-full uppercase tracking-widest">é€£å‡å°ˆæ¡ˆæ¨¡å¼</div>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">1. é¸æ“‡æ—¥æœŸç¯„åœ</label>
            <input type="text" id="dateRange" class="w-full p-4 border-none rounded-2xl text-lg text-center bg-slate-100 font-bold text-slate-700 focus:ring-2 focus:ring-green-200" placeholder="é»æ“Šé¸æ“‡æ—¥æœŸ">
            
            <div id="sunday-alert" class="hidden mt-4 p-4 bg-amber-50 border border-amber-100 rounded-2xl">
                <p class="text-sm text-amber-900 leading-relaxed font-medium">âœ¨ ç‚ºäº†çµ¦æ‚¨æœ€ä¹¾æ·¨çš„è‰åœ°èˆ‡ç’°å¢ƒï¼Œ<strong>é€±æ—¥é€²å ´æ™‚é–“ç‚º 14:00 å¾Œ</strong>ã€‚</p>
            </div>
            <div id="project-alert" class="hidden mt-4 p-4 bg-rose-50 border border-rose-100 rounded-2xl">
                <p id="project-msg" class="text-sm text-rose-900 leading-relaxed font-medium"></p>
            </div>
        </div>

        <div id="weekend-lock" class="hidden">
            <div class="bg-blue-600 p-8 rounded-[2rem] text-center text-white shadow-xl shadow-blue-100">
                <div class="text-4xl mb-4">ğŸ”ï¸</div>
                <h3 class="text-xl font-bold mb-2">é€±æœ«æ™‚æ®µ (äº”ã€å…­)</h3>
                <p class="text-blue-100 text-sm mb-6 leading-relaxed">ç†±é–€é€±æœ«ç›®å‰çµ±ä¸€æ–¼ã€æ„›éœ²ç‡Ÿã€‘é–‹æ”¾é è¨‚ã€‚</p>
                <a href="https://m.icamping.app/store/ljs761" target="_blank" rel="noopener noreferrer" class="block w-full bg-white text-blue-600 py-4 rounded-2xl font-bold shadow-lg text-center">å‰å¾€æ„›éœ²ç‡Ÿ (æ¨‚è¦‹å±±åˆ†é )</a>
            </div>
        </div>

        <div id="zone-selection" class="hidden space-y-4">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">2. é¸æ“‡ç‡Ÿä½èˆ‡å¸³æ•¸</label>
            <div id="zone-list" class="space-y-3 mb-8"></div>

            <div class="fixed bottom-6 left-4 right-4 max-w-md mx-auto bg-slate-900/95 backdrop-blur-md text-white p-6 rounded-[2rem] shadow-2xl border border-white/10">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest" id="summary-count">æœªé¸æ“‡</p>
                        <p id="total-price" class="text-2xl font-bold text-green-400">NT$ 0</p>
                    </div>
                    <button onclick="handleBooking()" id="submit-btn" class="bg-green-500 px-8 py-4 rounded-2xl font-bold text-white shadow-lg active:scale-95">ç¢ºèªè¨‚ä½</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://evdnzkvrmjnuzomogzar.supabase.co', 'sb_publishable_Tlpp57LlXUwYBRX84lI4WQ_MCv74hVQ');
        let selectedDates = [];
        let cart = {}; 
        let isHolidayProject = false;

        flatpickr("#dateRange", {
            mode: "range",
            minDate: "today",
            dateFormat: "Y-m-d",
            onClose: function(dates) {
                if (dates.length === 2) {
                    selectedDates = dates;
                    checkAvailability();
                }
            }
        });

        async function checkAvailability() {
            // UI é‡ç½®
            document.getElementById('sunday-alert').classList.add('hidden');
            document.getElementById('project-alert').classList.add('hidden');
            document.getElementById('project-tag').classList.add('hidden');
            const lockBox = document.getElementById('weekend-lock');
            const zoneBox = document.getElementById('zone-selection');
            
            const startStr = selectedDates[0].toLocaleDateString('en-CA');
            const endStr = selectedDates[1].toLocaleDateString('en-CA');

            // 1. ä¿®æ­£ç‰ˆï¼šé‡ç–Šåˆ¤å®šé‚è¼¯
            const { data: project } = await _supabase
                .from('holiday_config')
                .select('*')
                .lte('start_date', endStr)
                .gte('end_date', startStr)
                .maybeSingle();

            isHolidayProject = !!project;

            // 2. é€±æœ«åˆ¤å®š (å°ˆæ¡ˆä¸­å‰‡ä¸é–å®š)
            let hasWeekend = false;
            if (!isHolidayProject) {
                let scanDate = new Date(selectedDates[0]);
                while (scanDate < selectedDates[1]) {
                    if (scanDate.getDay() === 5 || scanDate.getDay() === 6) { hasWeekend = true; break; }
                    scanDate.setDate(scanDate.getDate() + 1);
                }
            }

            if (hasWeekend) {
                lockBox.classList.remove('hidden');
                zoneBox.classList.add('hidden');
                return;
            } else {
                lockBox.classList.add('hidden');
                zoneBox.classList.remove('hidden');
            }

            // 3. æç¤ºé‚è¼¯
            if (isHolidayProject) {
                document.getElementById('project-tag').classList.remove('hidden');
                document.getElementById('project-alert').classList.remove('hidden');
                document.getElementById('project-msg').innerText = `ğŸš© æœ¬æ™‚æ®µç‚ºã€${project.project_name}ã€‘ï¼Œé–‹æ”¾å…¨å€é è¨‚ã€‚`;
            } else if (selectedDates[0].getDay() === 0) {
                document.getElementById('sunday-alert').classList.remove('hidden');
            }

            // 4. æŠ“å–åº«å­˜èˆ‡æ¯”ä¾‹
            const { data: inventoryData } = await _supabase.from('inventory').select('*, zones(*)').gte('date', startStr).lt('date', endStr);
            const { data: rules } = await _supabase.from('site_rules').select('*');
            const weekdayRule = rules.find(r => r.id === 'weekday');
            
            // å°ˆæ¡ˆæœŸé–“æ¯”ä¾‹è¨­ç‚º 1.0 (å…¨é–‹)
            const currentRatio = isHolidayProject ? 1.0 : (weekdayRule ? weekdayRule.max_spots_ratio : 0.34);
            renderZones(inventoryData, currentRatio);
        }

        function renderZones(data, ratio) {
            const list = document.getElementById('zone-list');
            list.innerHTML = "";
            cart = {};
            const zoneMap = {};
            data.forEach(item => {
                if (!zoneMap[item.zone_id]) {
                    zoneMap[item.zone_id] = { name: item.zones.name, total_spots: item.zones.total_spots, min_avail: 99, total_price: 0, days: 0 };
                }
                const dynamicMax = Math.max(1, Math.floor(item.zones.total_spots * ratio));
                const currentAvail = Math.min(dynamicMax, item.remaining_spots);
                zoneMap[item.zone_id].min_avail = Math.min(zoneMap[item.zone_id].min_avail, currentAvail);
                zoneMap[item.zone_id].total_price += item.current_price;
                zoneMap[item.zone_id].days++;
            });

            Object.keys(zoneMap).forEach(id => {
                const z = zoneMap[id];
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center shadow-sm";
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-slate-800">${z.name}</div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">${isHolidayProject ? 'é€£å‡å…¨æ•¸é–‹æ”¾' : 'å¹³æ—¥é™åˆ¶ ' + z.min_avail + ' å¸³'}</p>
                    </div>
                    <select onchange="updateCart('${id}', this.value, ${z.total_price/z.days}, '${z.name}')" class="p-3 bg-slate-50 border-none rounded-2xl text-sm font-bold">
                        <option value="0">ä¸é è¨‚</option>
                        ${Array.from({length: z.min_avail}, (_, i) => `<option value="${i+1}">${i+1} å¸³</option>`).join('')}
                    </select>`;
                list.appendChild(card);
            });
            updateUI();
        }

        function updateCart(id, qty, price, name) {
            if (parseInt(qty) > 0) cart[id] = { quantity: parseInt(qty), pricePerNight: price, name: name };
            else delete cart[id];
            updateUI();
        }

        function updateUI() {
            const nights = Math.ceil((selectedDates[1] - selectedDates[0]) / 86400000);
            let total = 0; let count = 0;
            Object.values(cart).forEach(item => { total += item.quantity * item.pricePerNight * nights; count++; });
            document.getElementById('total-price').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summary-count').innerText = count > 0 ? `å·²é¸æ“‡ ${count} å€‹å€åŸŸ` : "å°šæœªé¸æ“‡";
            document.getElementById('submit-btn').disabled = count === 0;
        }

        async function handleBooking() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerHTML = "è™•ç†ä¸­...";
            const zoneIds = Object.keys(cart);
            const guestCounts = zoneIds.map(id => cart[id].quantity);
            const totalPrice = parseInt(document.getElementById('total-price').innerText.replace(/[NT$, ]/g, ''));

            const { data, error } = await _supabase.rpc('create_camp_booking_v2', {
                p_user_id: 'Guest_User', p_zone_ids: zoneIds,
                p_check_in: selectedDates[0].toLocaleDateString('en-CA'),
                p_check_out: selectedDates[1].toLocaleDateString('en-CA'),
                p_total_price: totalPrice, p_guest_counts: guestCounts
            });
            if (error) { alert("å¤±æ•—ï¼š" + error.message); btn.disabled = false; btn.innerHTML = "ç¢ºèªè¨‚ä½"; }
            else { alert("é è¨‚æˆåŠŸï¼"); location.reload(); }
        }
    </script>
</body>
</html>
