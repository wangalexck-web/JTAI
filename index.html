<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚è¦‹å±± CAMP - é è¨‚ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-slate-50">
    <div class="max-w-md mx-auto p-4 min-h-screen pb-32">
        <header class="text-center py-6">
            <h1 class="text-2xl font-bold text-slate-800">æ¨‚è¦‹å±± CAMP</h1>
            <p class="text-xs text-slate-400 tracking-widest uppercase">Mountains & Memories</p>
        </header>

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-4">
            <label class="block text-sm font-bold text-slate-700 mb-3">1. é¸æ“‡é è¨‚æ—¥æœŸ</label>
            <input type="text" id="dateRange" class="w-full p-4 border border-slate-200 rounded-xl text-lg text-center bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200" placeholder="é»æ“Šé¸æ“‡æ—¥æœŸç¯„åœ">
            
            <div id="sunday-alert" class="hidden mt-3 p-4 bg-amber-50 border border-amber-100 rounded-xl">
                <p class="text-sm text-amber-900 leading-relaxed font-medium">
                    âœ¨ ç‚ºäº†çµ¦æ‚¨æœ€ä¹¾æ·¨çš„è‰åœ°èˆ‡ç’°å¢ƒï¼Œ<strong>é€±æ—¥é€²å ´æ™‚é–“ç‚º 14:00 å¾Œ</strong>ã€‚ç‡Ÿä¸»æ­£åœ¨ç‚ºæ‚¨çš„åˆ°ä¾†é€²è¡Œæœ€å¾Œçš„æ‰“æƒèˆ‡æ•´å‚™ï¼Œæ„Ÿè¬æ‚¨çš„é«”è«’èˆ‡è€å¿ƒç­‰å¾…ã€‚
                </p>
            </div>
        </div>

        <div id="weekend-lock" class="hidden bg-blue-50 p-6 rounded-2xl border border-blue-100 text-center mb-4 transition-all">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="text-2xl">ğŸŒ²</span>
            </div>
            <p class="text-blue-900 font-bold mb-1">é€±äº”ã€é€±å…­æ™‚æ®µé è¨‚</p>
            <p class="text-xs text-blue-600 mb-4 leading-relaxed">ç›®å‰é€±æœ«æ™‚æ®µçµ±ä¸€æ–¼ã€æ„›éœ²ç‡Ÿã€‘å¹³å°é–‹æ”¾é è¨‚<br>æ­¡è¿é»æ“Šä¸‹æ–¹é€£çµå‰å¾€æ¨‚è¦‹å±±å°ˆå±¬é é¢ã€‚</p>
            <a href="https://m.icamping.app/store/ljs761" target="_blank" class="inline-block bg-blue-600 text-white px-8 py-3 rounded-full font-bold text-sm shadow-md active:scale-95 transition-all">
                å‰å¾€æ„›éœ²ç‡Ÿ (æ¨‚è¦‹å±±å°ˆå±¬)
            </a>
        </div>

        <div id="zone-selection" class="hidden">
            <label class="block text-sm font-bold text-slate-700 mb-3 px-1">2. é¸æ“‡ç‡Ÿä½èˆ‡å¸³æ•¸</label>
            <div id="zone-list" class="space-y-3 mb-6"></div>

            <div class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-slate-900 text-white p-5 rounded-2xl shadow-2xl border border-slate-700">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] uppercase tracking-wider opacity-50" id="summary-count">å°šæœªé¸æ“‡å€åŸŸ</p>
                        <p id="total-price" class="text-2xl font-bold text-green-400">NT$ 0</p>
                    </div>
                    <button onclick="handleBooking()" id="submit-btn" class="bg-green-500 px-8 py-4 rounded-xl font-bold text-white hover:bg-green-400 disabled:opacity-30 disabled:grayscale transition-all shadow-lg active:scale-95">
                        ç¢ºèªè¨‚ä½
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://evdnzkvrmjnuzomogzar.supabase.co', 'sb_publishable_Tlpp57LlXUwYBRX84lI4WQ_MCv74hVQ');
        let selectedDates = [];
        let cart = {}; 

        flatpickr("#dateRange", {
            mode: "range",
            minDate: "today",
            dateFormat: "Y-m-d",
            onClose: function(dates) {
                if (dates.length === 2) {
                    selectedDates = dates;
                    checkAvailability();
                }
            }
        });

        async function checkAvailability() {
            // é‡è¨­ UI ç‹€æ…‹
            document.getElementById('sunday-alert').classList.add('hidden');
            const lockBox = document.getElementById('weekend-lock');
            const zoneBox = document.getElementById('zone-selection');
            
            // åµæ¸¬é€±æœ« (é€±äº” 5, é€±å…­ 6)
            let hasWeekend = false;
            let scanDate = new Date(selectedDates[0]);
            let checkoutDate = new Date(selectedDates[1]);

            while (scanDate < checkoutDate) {
                const day = scanDate.getDay();
                if (day === 5 || day === 6) {
                    hasWeekend = true;
                    break;
                }
                scanDate.setDate(scanDate.getDate() + 1);
            }

            if (hasWeekend) {
                lockBox.classList.remove('hidden');
                zoneBox.classList.add('hidden');
                return;
            } else {
                lockBox.classList.add('hidden');
                zoneBox.classList.remove('hidden');
            }

            // é€±æ—¥é€²å ´æé†’åˆ¤å®š
            if (selectedDates[0].getDay() === 0) {
                document.getElementById('sunday-alert').classList.remove('hidden');
            }

            const start = selectedDates[0].toLocaleDateString('en-CA');
            const end = selectedDates[1].toLocaleDateString('en-CA');

            // æŠ“å–åº«å­˜èˆ‡å¹³æ—¥è¦å‰‡
            const { data: inventoryData } = await _supabase.from('inventory').select('*, zones(*)').gte('date', start).lt('date', end);
            const { data: rules } = await _supabase.from('site_rules').select('*');
            const weekdayRule = rules.find(r => r.id === 'weekday');

            renderZones(inventoryData, weekdayRule ? weekdayRule.max_spots_ratio : 0.34);
        }

        function renderZones(data, ratio) {
            const list = document.getElementById('zone-list');
            list.innerHTML = "";
            cart = {};
            
            const zoneMap = {};
            data.forEach(item => {
                if (!zoneMap[item.zone_id]) {
                    zoneMap[item.zone_id] = { 
                        name: item.zones.name, 
                        total_spots: item.zones.total_spots,
                        min_avail: 99, 
                        total_price: 0,
                        days: 0
                    };
                }
                // å¹³æ—¥æ¸›å¸³è¨ˆç®—
                const dynamicMax = Math.max(1, Math.floor(item.zones.total_spots * ratio));
                const currentAvail = Math.min(dynamicMax, item.remaining_spots);
                
                zoneMap[item.zone_id].min_avail = Math.min(zoneMap[item.zone_id].min_avail, currentAvail);
                zoneMap[item.zone_id].total_price += item.current_price;
                zoneMap[item.zone_id].days++;
            });

            Object.keys(zoneMap).forEach(id => {
                const z = zoneMap[id];
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm";
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-slate-800 text-lg">${z.name}</div>
                        <div class="text-[10px] text-slate-400 font-medium">å¹³æ—¥é–‹æ”¾ä¸Šé™ ${z.min_avail} å¸³</div>
                    </div>
                    <select onchange="updateCart('${id}', this.value, ${z.total_price/z.days}, '${z.name}')" class="p-3 border-none bg-slate-100 rounded-xl text-sm font-bold focus:ring-2 focus:ring-green-500">
                        <option value="0">ä¸é è¨‚</option>
                        ${Array.from({length: z.min_avail}, (_, i) => `<option value="${i+1}">${i+1} å¸³</option>`).join('')}
                    </select>
                `;
                list.appendChild(card);
            });
            updateUI();
        }

        function updateCart(id, qty, price, name) {
            if (parseInt(qty) > 0) {
                cart[id] = { quantity: parseInt(qty), pricePerNight: price, name: name };
            } else {
                delete cart[id];
            }
            updateUI();
        }

        function updateUI() {
            const nights = Math.ceil((selectedDates[1] - selectedDates[0]) / 86400000);
            let total = 0;
            let count = 0;
            Object.values(cart).forEach(item => {
                total += item.quantity * item.pricePerNight * nights;
                count++;
            });
            document.getElementById('total-price').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summary-count').innerText = count > 0 ? `å·²é¸æ“‡ ${count} å€‹å€åŸŸ` : "å°šæœªé¸æ“‡å€åŸŸ";
            document.getElementById('submit-btn').disabled = count === 0;
        }

        async function handleBooking() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="inline-block animate-spin mr-2">â³</span>è™•ç†ä¸­`;

            const zoneIds = Object.keys(cart);
            const guestCounts = zoneIds.map(id => cart[id].quantity);
            const totalPrice = parseInt(document.getElementById('total-price').innerText.replace(/[NT$, ]/g, ''));

            const { data, error } = await _supabase.rpc('create_camp_booking_v2', {
                p_user_id: 'Guest_User',
                p_zone_ids: zoneIds,
                p_check_in: selectedDates[0].toLocaleDateString('en-CA'),
                p_check_out: selectedDates[1].toLocaleDateString('en-CA'),
                p_total_price: totalPrice,
                p_guest_counts: guestCounts
            });

            if (error) {
                alert("é è¨‚æœªèƒ½æˆåŠŸï¼š" + error.message);
                btn.disabled = false;
                btn.innerHTML = "ç¢ºèªè¨‚ä½";
            } else {
                alert("é è¨‚æˆåŠŸï¼æ¨‚è¦‹å±±æœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚");
                location.reload();
            }
        }
    </script>
</body>
</html>
