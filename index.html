<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樂見山 CAMP - 壓力測試中</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-8">
    <div class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg">
        <h1 class="text-xl font-bold mb-4">樂見山系統：併發壓力測試</h1>
        <p class="text-sm text-gray-600 mb-6">點擊下方按鈕，系統將模擬 10 人同時搶訂「2026-01-01 A區」。</p>
        
        <div id="test-result" class="mb-6 p-4 bg-slate-100 rounded-lg hidden">
            <p id="summary" class="font-bold mb-2"></p>
            <div id="details" class="text-xs font-mono space-y-1"></div>
        </div>

        <button onclick="runStressTest()" id="btn-test" class="w-full bg-red-500 text-white py-4 rounded-xl font-bold hover:bg-red-600 transition-all">
            啟動 10 人搶位測試
        </button>
    </div>

    <script>
        const _supabase = supabase.createClient('https://evdnzkvrmjnuzomogzar.supabase.co', 'sb_publishable_Tlpp57LlXUwYBRX84lI4WQ_MCv74hVQ');

        async function runStressTest() {
            const btn = document.getElementById('btn-test');
            const resultDiv = document.getElementById('test-result');
            const summary = document.getElementById('summary');
            const details = document.getElementById('details');

            btn.disabled = true;
            btn.innerText = "測試執行中...";
            resultDiv.classList.remove('hidden');
            details.innerHTML = "";

            // 模擬 10 個併發請求
            const requests = Array.from({ length: 10 }).map((_, i) => {
                return _supabase.rpc('create_camp_booking', {
                    p_user_id: `Tester_${i + 1}`,
                    p_zone_ids: ['A'], 
                    p_check_in: '2026-01-01',
                    p_check_out: '2026-01-02',
                    p_total_price: 1100
                });
            });

            const results = await Promise.all(requests);
            
            let successCount = 0;
            let errorCount = 0;

            results.forEach((r, i) => {
                const isSuccess = r.data && r.data.includes('SUCCESS');
                if (isSuccess) successCount++; else errorCount++;
                
                const item = document.createElement('div');
                item.className = isSuccess ? 'text-green-600' : 'text-red-600';
                item.innerText = `請求 ${i+1}: ${r.data || r.error.message}`;
                details.appendChild(item);
            });

            summary.innerText = `✅ 成功: ${successCount} | ❌ 失敗: ${errorCount}`;
            btn.disabled = false;
            btn.innerText = "重新測試";
            
            if (successCount === 1) {
                alert("測試完美！資料庫成功擋住超賣，僅 1 人搶到位置。");
            }
        }
    </script>
</body>
</html>
