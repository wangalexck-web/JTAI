<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樂見山 CAMP - 預訂系統</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-slate-50">
    <div class="max-w-md mx-auto p-4 min-h-screen pb-32">
        <header class="text-center py-6">
            <h1 class="text-2xl font-bold text-slate-800">樂見山 CAMP</h1>
            <p class="text-xs text-slate-400">專屬訂位服務</p>
        </header>

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-4">
            <label class="block text-sm font-bold text-slate-700 mb-3">1. 選擇預訂日期</label>
            <input type="text" id="dateRange" class="w-full p-4 border border-slate-200 rounded-xl text-lg text-center bg-slate-50" placeholder="點擊選擇日期範圍">
            
            <div id="sunday-alert" class="hidden mt-3 p-3 bg-amber-50 border border-amber-100 rounded-lg">
                <p class="text-xs text-amber-800 leading-relaxed">
                    ✨ 為了給您最乾淨的草地與環境，<strong>週日進場時間為 14:00 後</strong>。營主正在為您的到來進行最後的打掃與整備，感謝您的體諒與耐心等待。
                </p>
            </div>
        </div>

        <div id="weekend-lock" class="hidden bg-blue-50 p-6 rounded-2xl border border-blue-100 text-center mb-4">
            <p class="text-blue-800 font-bold mb-3">週五、週六時段</p>
            <p class="text-sm text-blue-600 mb-4">目前週末統一於【愛露營】平台開放預訂</p>
            <a href="https://m.icamping.app/" target="_blank" class="inline-block bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-sm">前往愛露營</a>
        </div>

        <div id="zone-selection" class="hidden">
            <label class="block text-sm font-bold text-slate-700 mb-3 px-1">2. 選擇營位與帳數</label>
            <div id="zone-list" class="space-y-3 mb-6"></div>

            <div class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-slate-800 text-white p-5 rounded-2xl shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-xs opacity-70" id="summary-count">已選 0 區</p>
                        <p id="total-price" class="text-xl font-bold">NT$ 0</p>
                    </div>
                    <button onclick="handleBooking()" id="submit-btn" class="bg-green-500 px-8 py-3 rounded-xl font-bold hover:bg-green-400 disabled:opacity-50 transition-all">
                        確認訂位
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://evdnzkvrmjnuzomogzar.supabase.co', 'sb_publishable_Tlpp57LlXUwYBRX84lI4WQ_MCv74hVQ');
        let selectedDates = [];
        let cart = {}; // 格式: { zone_id: { quantity, pricePerNight, name } }

        flatpickr("#dateRange", {
            mode: "range",
            minDate: "today",
            maxDate: new Date().fp_incr(90),
            dateFormat: "Y-m-d",
            onClose: function(dates) {
                if (dates.length === 2) {
                    selectedDates = dates;
                    checkSundayAlert(dates[0]);
                    checkAvailability();
                }
            }
        });

        function checkSundayAlert(checkInDate) {
            const alertBox = document.getElementById('sunday-alert');
            // 週日是 0
            if (checkInDate.getDay() === 0) {
                alertBox.classList.remove('hidden');
            } else {
                alertBox.classList.add('hidden');
            }
        }

        async function checkAvailability() {
            const start = selectedDates[0].toISOString().split('T')[0];
            const end = selectedDates[1].toISOString().split('T')[0];
            
            // 檢查是否包含週五(5)或週六(6)
            let hasWeekend = false;
            let curr = new Date(selectedDates[0]);
            while (curr < selectedDates[1]) {
                if (curr.getDay() === 5 || curr.getDay() === 6) hasWeekend = true;
                curr.setDate(curr.getDate() + 1);
            }

            const lockBox = document.getElementById('weekend-lock');
            const zoneBox = document.getElementById('zone-selection');

            if (hasWeekend) {
                lockBox.classList.remove('hidden');
                zoneBox.classList.add('hidden');
                return;
            } else {
                lockBox.classList.add('hidden');
                zoneBox.classList.remove('hidden');
            }

            // 抓取庫存與規則 (平日比例)
            const { data: inventoryData } = await _supabase.from('inventory').select('*, zones(*)').gte('date', start).lt('date', end);
            const { data: rules } = await _supabase.from('site_rules').select('*');
            const weekdayRule = rules.find(r => r.id === 'weekday');

            renderZones(inventoryData, weekdayRule.max_spots_ratio);
        }

        function renderZones(data, ratio) {
            const list = document.getElementById('zone-list');
            list.innerHTML = "";
            cart = {};
            
            const zoneMap = {};
            data.forEach(item => {
                if (!zoneMap[item.zone_id]) {
                    zoneMap[item.zone_id] = { 
                        name: item.zones.name, 
                        total_spots: item.zones.total_spots,
                        min_avail: 99, 
                        total_price: 0,
                        days: 0
                    };
                }
                // 平日減帳計算: 總帳數 * 比例 (無條件進位/捨去視規則，此處採簡單計算)
                const dynamicMax = Math.max(1, Math.floor(item.zones.total_spots * ratio));
                const currentAvail = Math.min(dynamicMax, item.remaining_spots);
                
                zoneMap[item.zone_id].min_avail = Math.min(zoneMap[item.zone_id].min_avail, currentAvail);
                zoneMap[item.zone_id].total_price += item.current_price;
                zoneMap[item.zone_id].days++;
            });

            Object.keys(zoneMap).forEach(id => {
                const z = zoneMap[id];
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center";
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-slate-800">${z.name}</div>
                        <div class="text-xs text-slate-500">平日限定開放 ${z.min_avail} 帳</div>
                    </div>
                    <select onchange="updateCart('${id}', this.value, ${z.total_price/z.days}, '${z.name}')" class="p-2 border rounded-lg bg-slate-50 text-sm">
                        <option value="0">不預訂</option>
                        ${Array.from({length: z.min_avail}, (_, i) => `<option value="${i+1}">${i+1} 帳</option>`).join('')}
                    </select>
                `;
                list.appendChild(card);
            });
            updateUI();
        }

        function updateCart(id, qty, price, name) {
            if (qty > 0) {
                cart[id] = { quantity: parseInt(qty), pricePerNight: price, name: name };
            } else {
                delete cart[id];
            }
            updateUI();
        }

        function updateUI() {
            const nights = Math.ceil((selectedDates[1] - selectedDates[0]) / 86400000);
            let total = 0;
            let count = 0;
            Object.values(cart).forEach(item => {
                total += item.quantity * item.pricePerNight * nights;
                count++;
            });
            document.getElementById('total-price').innerText = `NT$ ${total}`;
            document.getElementById('summary-count').innerText = `已選 ${count} 個區域`;
            document.getElementById('submit-btn').disabled = count === 0;
        }

        async function handleBooking() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = "處理中...";

            const zoneIds = Object.keys(cart);
            const guestCounts = zoneIds.map(id => cart[id].quantity);
            const totalPrice = parseInt(document.getElementById('total-price').innerText.replace('NT$ ', ''));

            // 呼叫新版大腦 create_camp_booking_v2
            const { data, error } = await _supabase.rpc('create_camp_booking_v2', {
                p_user_id: 'Line_User_Demo',
                p_zone_ids: zoneIds,
                p_check_in: selectedDates[0].toISOString().split('T')[0],
                p_check_out: selectedDates[1].toISOString().split('T')[0],
                p_total_price: totalPrice,
                p_guest_counts: guestCounts
            });

            if (error) {
                alert("預訂失敗：" + error.message);
                btn.disabled = false;
                btn.innerText = "確認訂位";
            } else {
                alert("預訂成功！樂見山期待您的光臨。");
                location.reload();
            }
        }
    </script>
</body>
</html>
